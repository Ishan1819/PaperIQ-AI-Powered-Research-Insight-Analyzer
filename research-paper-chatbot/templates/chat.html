<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Research Paper Chatbot</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="/" class="nav-brand">
          <span class="brand-icon">ðŸŽ“</span>
          Research Paper Chatbot
        </a>
        <div class="nav-links">
          <a href="/" class="nav-link">Home</a>
          <a href="/upload" class="nav-link">Upload</a>
          <a href="/summary" class="nav-link">Summary</a>
        </div>
      </div>
    </nav>

    <div class="chat-container">
      <div class="chat-header">
        <h2>Chat with Your Document</h2>
        <p class="document-name">ðŸ“„ {{ filename }}</p>
      </div>

      <div id="chatMessages" class="chat-messages">
        <div class="welcome-message">
          <div class="welcome-icon">ðŸ‘‹</div>
          <p class="welcome-title">
            Hello! I'm ready to answer questions about your research paper.
          </p>
          <p class="welcome-subtitle">Try asking questions like:</p>
          <ul>
            <li>"What is the main topic of this paper?"</li>
            <li>"What are the key features?"</li>
            <li>"How does this work?"</li>
            <li>"What are the conclusions?"</li>
          </ul>
        </div>
      </div>

      <div class="chat-input-container">
        <form id="chatForm" class="chat-form">
          <input
            type="text"
            id="questionInput"
            class="chat-input"
            placeholder="Ask a question about your document..."
            autocomplete="off"
            required
          />
          <button type="submit" class="chat-submit" id="sendBtn">
            <span class="send-icon">âž¤</span>
          </button>
        </form>
      </div>
    </div>

    <script>
      const chatForm = document.getElementById("chatForm");
      const questionInput = document.getElementById("questionInput");
      const chatMessages = document.getElementById("chatMessages");
      const sendBtn = document.getElementById("sendBtn");

      function addMessage(text, isUser) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${
          isUser ? "user-message" : "bot-message"
        }`;

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";
        messageContent.textContent = text;

        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "chat-message bot-message typing-indicator";
        typingDiv.id = "typingIndicator";

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";
        messageContent.innerHTML =
          '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';

        typingDiv.appendChild(messageContent);
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const question = questionInput.value.trim();
        if (!question) return;

        addMessage(question, true);
        questionInput.value = "";
        sendBtn.disabled = true;
        showTypingIndicator();

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
          });

          const data = await response.json();
          removeTypingIndicator();

          if (response.ok) {
            addMessage(data.answer, false);
          } else {
            addMessage(data.error || "Sorry, I encountered an error.", false);
          }
        } catch (error) {
          removeTypingIndicator();
          addMessage("Error: Unable to connect to the server.", false);
        } finally {
          sendBtn.disabled = false;
          questionInput.focus();
        }
      });

      // Auto-focus input on load
      questionInput.focus();
    </script>
  </body>
</html>
